import{chalk as t,fs as e}from"@vuepress/utils";import{isLinkHttp as i,removeEndingSlash as a,removeLeadingSlash as r}from"@vuepress/shared";import{Logger as n,deepAssign as s,encodeXML as o,encodeCDATA as p,stripTags as u,isUrl as l,getAuthor as h,getCategory as c,isAbsoluteUrl as m}from"vuepress-shared";import{dirname as g}from"node:path";import{js2xml as d}from"xml-js";const f=new n("vuepress-plugin-feed2"),b=(t,e)=>t&&t instanceof Date?e&&e instanceof Date?e.getTime()-t.getTime():-1:1,y=(t,e=[])=>t.replace(/ class=".*?"/gu,"").replace(/ v-pre/gu,"").replace(/<a href="#.*?">.*?<\/a>/gu,"").replace(/(<!--.*?--!?>)|(<!--[\S\s]+?--!?>)|(<!--[\S\s]*?$)/gu,"").replace(/<ExternalLinkIcon ?\/>/gu,"").replace(/<RouterLink to="(.*?)">(.*?)<\/RouterLink>/gu,'<a href="$1">$2</a>').replace(/<(?:a|div|span)[^>]*?\/>/gu,"").replace(new RegExp(`<(${e.join("|")})[^>]*?(?:>*?<\\/\\1>|\\/>)`,"gu"),"<i>Content not supported</i>").replace(/<math[\s\S]*?\/math>/gu,"<i>Content not supported</i>"),_=(t,e="",n="")=>`${i(t)?a(t):`https://${a(t)}`}${e}${r(n)}`,O=(t="")=>`image/${"jpg"===t?"jpeg":"svg"===t?"svg+xml":"jpeg"===t||"png"===t||"bmp"===t||"gif"===t||"webp"===t?t:""}`,F=t=>{t.atom=t.output?.atom?.enable??!0,t.json=t.output?.json?.enable??!0,t.rss=t.output?.rss?.enable??!0,t.atomOutputFilename=t.output?.atom?.path??"atom.xml",t.jsonOutputFilename=t.output?.json?.path??"feed.json",t.jsonOutputFilename=t.output?.rss?.path??"rss.xml",((t,e,i="",a="")=>{e in t&&(f.error(`"${e}" is removed${a?`, please use ${a} instead.`:" and no longer supported"}${i?`\n${i}`:""}`),a||delete t[e])})(t,"output")},x=(t,e,i="")=>{const{base:a}=t.options,{title:r,description:n,lang:o,locales:p}=t.siteData,{hostname:u,icon:l,image:h}=e,c=e.channel?.author?.name,m={title:p[i]?.title||r||p["/"]?.title||"",link:_(u,a,i),description:p[i]?.description||n||p["/"]?.description||"",language:p[i]?.lang||o,copyright:c?`Copyright by ${c}`:"",pubDate:new Date,lastUpdated:new Date,...l?{icon:l}:{},...h?{image:h}:{},...c?{author:{name:c}}:{}};return s(m,e.channel||{})},k=(t,e="/")=>({atomOutputFilename:`${r(e)}${t.atomOutputFilename||"atom.xml"}`,jsonOutputFilename:`${r(e)}${t.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${r(e)}${t.rssOutputFilename||"rss.xml"}`}),j=({options:{base:t}},e)=>{const{hostname:i}=e,{atomOutputFilename:a,jsonOutputFilename:r,rssOutputFilename:n}=k(e);return{atom:_(i,t,a),json:_(i,t,r),rss:_(i,t,n)}},D=t=>{const{name:e="Unknown",email:i,url:a}=t;return{name:e,...i?{email:i}:{},...a?{uri:o(a)}:{}}},w=t=>{const e=t.guid||o(t.link);return{...l(e)?{}:{_attributes:{isPermaLink:!1}},_text:e}};class ${constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=t=>{this.items.push(t)},this.addCategory=t=>{this.categories.add(t)},this.addContributor=t=>{const e=t.email||t.name;e&&!this._contributorKeys.has(e)&&(this._contributorKeys.add(e),this.contributors.push(t))},this.atom=()=>(t=>{const{channel:e,links:i}=t.options,a={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...e.language?{"xml:lang":e.language}:{}},id:e.link,title:e.title,...e.description?{subtitle:e.description}:{},...e.author?{author:D(e.author)}:{},updated:e.lastUpdated?e.lastUpdated.toISOString():(new Date).toISOString(),generator:"vuepress-plugin-feed2",link:[{_attributes:{rel:"self",href:o(i.atom)}}]}};return e.link&&a.feed.link.push({_attributes:{rel:"alternate",href:o(e.link)}}),e.hub&&a.feed.link.push({_attributes:{rel:"hub",href:o(e.hub)}}),e.image&&(a.feed.logo=e.image),e.icon&&(a.feed.icon=e.icon),e.copyright&&(a.feed.rights=e.copyright),a.feed.category=Array.from(t.categories).map((t=>({_attributes:{term:t}}))),a.feed.contributor=Array.from(t.contributors).filter((t=>t.name)).map((t=>D(t))),a.feed.entry=t.items.map((t=>{const e={title:{_attributes:{type:"html"},_text:o(t.title)},id:o(t.guid||t.link),link:{_attributes:{href:o(t.link)}},updated:t.lastUpdated.toISOString()};return t.description&&(e.summary=t.description.startsWith("html:")?{_attributes:{type:"html"},_cdata:p(t.description.substring(5))}:{_attributes:{type:"html"},_text:t.description}),t.content&&(e.content={_attributes:{type:"html"},_cdata:p(t.content)}),t.author&&(e.author=t.author.filter((t=>t.name)).map((t=>D(t)))),t.category&&(e.category=t.category.map((t=>(t=>{const{name:e,scheme:i=""}=t;return{_attributes:{term:e,scheme:i}}})(t)))),t.contributor&&(e.contributor=t.contributor.map((t=>D(t)))),t.pubDate&&(e.published=t.pubDate.toISOString()),t.copyright&&(e.rights=t.copyright),e})),d(a,{compact:!0,ignoreComment:!0,spaces:2})})(this),this.rss=()=>(t=>{const{links:e,channel:i}=t.options;let a=!1;const r={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:e.rss,rel:"self",type:"application/rss+xml"}},title:{_text:i.title},link:{_text:o(i.link)},description:{_text:i.description},language:{_text:o(i.language)},pubDate:{_text:i.pubDate?i.pubDate.toUTCString():(new Date).toUTCString()},lastBuildDate:{_text:i.lastUpdated?i.lastUpdated.toUTCString():(new Date).toUTCString()},generator:{_text:"vuepress-plugin-feed2"},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return i.copyright&&(r.rss.channel.copyright={_text:i.copyright}),i.ttl&&(r.rss.channel.ttl={_text:i.ttl.toString()}),i.image&&(r.rss.channel.image={title:{_text:i.title},url:{_text:i.image},link:{_text:o(i.link)}}),r.rss.channel.category=Array.from(t.categories).map((t=>({_text:t}))),r.rss.channel.item=t.items.map((t=>{const i={title:{_text:o(t.title)},link:{_text:o(t.link)},guid:w(t),source:{_attributes:{url:e.rss},_text:t.title}};if(t.description&&(i.description={_text:t.description.startsWith("html:")?u(t.description.substring(5)):t.description}),t.author){const e=t.author.find((t=>t.email&&t.name));e&&(i.author={_text:`${e.email} (${e.name})`})}var r;return t.category&&(i.category=t.category.filter((t=>t.name)).map((t=>(t=>{const{name:e,domain:i}=t;return{_text:e,...i?{_attributes:{domain:i}}:{}}})(t)))),t.comments&&(i.comments={_text:o(t.link)}),t.pubDate&&(i.pubDate={_text:t.pubDate.toUTCString()}),t.content&&(a=!0,i["content:encoded"]={_cdata:p(t.content)}),t.enclosure&&(i.enclosure={_attributes:{url:(r=t.enclosure).url,...r.length?{length:r.length}:{},...r.type?{type:r.type}:{}}}),i})),a&&(r.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",r.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),d(r,{compact:!0,ignoreComment:!0,spaces:2})})(this),this.json=()=>(t=>{const{channel:e,links:i}=t.options,a={version:"https://jsonfeed.org/version/1.1",title:e.title,home_page_url:e.link,feed_url:i.json};return e.description&&(a.description=e.description),e.image&&(a.icon=e.image),e.icon&&(a.favicon=e.icon),e.author?.name&&(a.author={name:e.author.name,...e.author.url?{url:e.author.url}:{},...e.author.avatar?{avatar:e.author.avatar}:{}}),a.items=t.items.map((t=>{const e={title:t.title,url:t.link,id:t.guid||t.link,...t.description?{summary:t.description.startsWith("html:")?u(t.description.substring(5)):t.description}:{},content_html:t.content};return t.image&&(e.image=t.image),t.pubDate&&(e.date_published=t.pubDate.toISOString()),t.lastUpdated&&(e.date_modified=t.lastUpdated.toISOString()),Array.isArray(t.author)&&(e.authors=t.author.filter((t=>t.name)).map((t=>(t=>({name:t.name,...t.url?{url:t.url}:{},...t.avatar?{avatar:t.avatar}:{}}))(t)))),t.category&&(e.tags=t.category.filter((t=>t.name)).map((t=>t.name))),e})),JSON.stringify(a,null,2)})(this)}}class S{constructor(t,e,i,a){this.app=t,this.options=e,this.page=i,this.feed=a,this.base=this.app.options.base,this.frontmatter=i.frontmatter,this.getter=e.getter||{},this.pageFeedOptions=this.frontmatter.feed||{}}get title(){return"function"==typeof this.getter.title?this.getter.title(this.page):this.pageFeedOptions.title||this.page.title}get link(){return"function"==typeof this.getter.link?this.getter.link(this.page):_(this.options.hostname,this.base,this.page.path)}get description(){return"function"==typeof this.getter.description?this.getter.description(this.page):this.pageFeedOptions.description?this.pageFeedOptions.description:this.frontmatter.description?this.frontmatter.description:this.page.excerpt?`html:${y(this.app.markdown.render(this.page.excerpt),this.options.customElements)}`:null}get author(){return"function"==typeof this.getter.author?this.getter.author(this.page):Array.isArray(this.pageFeedOptions.author)?this.pageFeedOptions.author:"object"==typeof this.pageFeedOptions.author?[this.pageFeedOptions.author]:!1===this.frontmatter.author?[]:this.frontmatter.author?h(this.frontmatter.author):this.options.channel?.author?h(this.options.channel?.author):[]}get category(){if("function"==typeof this.getter.category)return this.getter.category(this.page);if(Array.isArray(this.pageFeedOptions.category))return this.pageFeedOptions.category;if("object"==typeof this.pageFeedOptions.category)return[this.pageFeedOptions.category];const{categories:t,category:e=t}=this.frontmatter;return c(e).map((t=>({name:t})))}get enclosure(){return"function"==typeof this.getter.enclosure?this.getter.enclosure(this.page):this.image?{url:this.image,type:O(this.image.split(".").pop())}:null}get guid(){return this.pageFeedOptions.guid||this.link}get pubDate(){if("function"==typeof this.getter.publishDate)return this.getter.publishDate(this.page);const{time:t,date:e=t}=this.page.frontmatter,{createdTime:i}=this.page.data.git||{};return e&&e instanceof Date?e:i?new Date(i):null}get lastUpdated(){if("function"==typeof this.getter.lastUpdateDate)return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get content(){return"function"==typeof this.getter.content?this.getter.content(this.page):this.pageFeedOptions.content?this.pageFeedOptions.content:y(this.page.contentRendered,this.options.customElements)}get image(){if("function"==typeof this.getter.image)return this.getter.image(this.page);const{banner:t,cover:e}=this.frontmatter;if(t){if(m(t))return _(this.options.hostname,this.app.options.base,t);if(l(t))return t}if(e){if(m(e))return _(this.options.hostname,this.app.options.base,e);if(l(e))return e}const i=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(i){if(m(i[1]))return _(this.options.hostname,this.app.options.base,i[1]);if(l(i[1]))return i[1]}return null}get contributor(){return"function"==typeof this.getter.contributor?this.getter.contributor(this.page):Array.isArray(this.pageFeedOptions.contributor)?this.pageFeedOptions.contributor:"object"==typeof this.pageFeedOptions.contributor?[this.pageFeedOptions.contributor]:this.author}get copyright(){if("function"==typeof this.getter.copyright)return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t?.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:e,content:i,contributor:a,copyright:r,description:n,enclosure:s,guid:o,image:p,lastUpdated:u,link:l,pubDate:h,title:c}=this;return c||n?(e&&e.forEach((t=>this.feed.addCategory(t.name))),a&&a.forEach((t=>this.feed.addContributor(t))),{title:c,link:l,guid:o,lastUpdated:u,content:i,author:t,contributor:a,...n?{description:n}:{},...e?{category:e}:{},...s?{enclosure:s}:{},...h?{pubDate:h}:{},...p?{image:p}:{},...r?{copyright:r}:{}}):null}}class v{constructor(t,e){this.app=t,this.options=e,this.feedMap=Object.fromEntries(Object.entries(e).map((([e,i])=>[e,new $({channel:x(t,i,e),links:j(t,i)})])))}addPages(e){const i=this.feedMap[e],a=this.options[e],{count:r=100,filter:n=(({frontmatter:t,filePathRelative:e})=>!(t.home||!e||!1===t.article||!1===t.feed)),sorter:s=((t,e)=>b(t.data.git?.createdTime?new Date(t.data.git?.createdTime):t.frontmatter.date,e.data.git?.createdTime?new Date(e.data.git?.createdTime):e.frontmatter.date))}=a,o=this.app.pages.filter((t=>t.pathLocale===e)).filter(n).sort(s).slice(0,r);let p=0;for(const t of o){const e=new S(this.app,a,t,i).getFeedItem();e&&(i.addItem(e),p+=1)}f.succeed(`added ${t.cyan(`${p} page(s)`)} as feed item(s) in route ${t.cyan(e)}`)}async generateFeed(){const{dest:i}=this.app.dir;await Promise.all(Object.entries(this.options).map((async([a,r])=>{if(r.atom||r.json||r.rss){const n=this.feedMap[a],{atomOutputFilename:s,jsonOutputFilename:o,rssOutputFilename:p}=k(r,a);this.addPages(a),r.atom&&(await e.ensureDir(g(i(s))),await e.outputFile(i(s),n.atom()),f.succeed(`Atom feed file generated and saved to ${t.cyan(s)}`)),r.json&&(await e.ensureDir(g(i(o))),await e.outputFile(i(o),n.json()),f.succeed(`JSON feed file generated and saved to ${t.cyan(o)}`)),r.rss&&(await e.ensureDir(g(i(p))),await e.outputFile(i(p),n.rss()),f.succeed(`RSS feed file generated and saved to ${t.cyan(p)}`))}})))}}const U=(e,r=!1)=>n=>{r&&F(e),n.env.isDebug&&f.info(`Options: ${e.toString()}`);const s={name:"vuepress-plugin-feed2"};if(!(t=>!!t.hostname&&(t.hostname=i(t.hostname)?a(t.hostname):`https://${a(t.hostname)}`,!0))(e))return f.error(`Option ${t.magenta("hostname")} is required!`),s;if(!(t=>t.locales&&Object.entries(t.locales).some((([,{atom:t,json:e,rss:i}])=>t||e||i))||Boolean(t.atom||t.json||t.rss))(e))return f.info("No requested output, the plugin won’t start!"),s;const o=(({siteData:t},e)=>Object.fromEntries(Object.keys({"/":{},...t.locales}).map((t=>[t,{filter:({frontmatter:t,filePathRelative:e})=>!(t.home||!e||!1===t.article||!1===t.feed),sorter:(t,e)=>b(t.data.git?.createdTime?new Date(t.data.git?.createdTime):t.frontmatter.date,e.data.git?.createdTime?new Date(e.data.git?.createdTime):e.frontmatter.date),...e,...e.locales?.[t],hostname:e.hostname}]))))(n,e);return{...s,onPrepared:t=>((t,e)=>{const{base:i}=t.options,{siteData:a}=t,r=Object.keys(e);if(1===r.length){const{atomOutputFilename:t,jsonOutputFilename:r,rssOutputFilename:n}=k(e["/"]),{atom:s,json:o,rss:p,hostname:u}=e["/"],l=(t,e,r)=>["link",{rel:"alternate",type:r,href:_(u,i,e),title:`${a.title||a.locales["/"]?.title||""} ${t} Feed`}];a.head||(a.head=[]),s&&a.head.push(l("Atom",t,"application/atom+xml")),o&&a.head.push(l("JSON",r,"application/json")),p&&a.head.push(l("RSS",n,"application/rss+xml"))}else t.pages.forEach((t=>{const{pathLocale:n}=t,s=e[n];if(r.includes(n)){const{atomOutputFilename:e,jsonOutputFilename:r,rssOutputFilename:o}=k(s,n),p=(t,e,r)=>["link",{rel:"alternate",type:r,href:_(s.hostname,i,e),title:`${a.locales[n]?.title||a.title||a.locales["/"]?.title||""} ${t} Feed`}];t.frontmatter.head||(t.frontmatter.head=[]),s.atom&&t.frontmatter.head.push(p("Atom",e,"application/atom+xml")),s.json&&t.frontmatter.head.push(p("JSON",r,"application/json")),s.rss&&t.frontmatter.head.push(p("RSS",o,"application/rss+xml"))}}))})(t,o),onGenerated:async t=>{await new v(t,o).generateFeed()}}};export{U as default,U as feedPlugin};
//# sourceMappingURL=index.js.map
